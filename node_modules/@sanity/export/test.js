const path = require('path')
const miss = require('mississippi')
const split = require('split2')
const sanityClient = require('@sanity/client')
const AssetHandler = require('./src/AssetHandler')
const stringifyStream = require('./src/stringifyStream')
const rejectOnApiError = require('./src/rejectOnApiError')
const getDocumentsStream = require('./src/getDocumentsStream')
const filterSystemDocuments = require('./src/filterSystemDocuments')
const filterDocumentTypes = require('./src/filterDocumentTypes')
const filterDrafts = require('./src/filterDrafts')
const logFirstChunk = require('./src/logFirstChunk')
const tryParseJson = require('./src/tryParseJson')

const client = sanityClient({
  projectId: 'nn1enxmz',
  dataset: 'production',
  useCdn: false
})

// https://nn1enxmz.api.sanity.io/v1/data/doc/production/image-cf7111c7dd3bcaa43ca22b496c24a0a93913ff99-534x800-jpg

const assetHandler = new AssetHandler({
  client,
  tmpDir: path.join(__dirname, 'tmp'),
  prefix: `export-${Date.now()}`,
  concurrency: 1
})

let documentCount = 0
let lastReported = Date.now()

const reportDocumentCount = (chunk, enc, cb) => {
  ++documentCount

  const now = Date.now()
  if (now - lastReported > 100) {
    console.log(documentCount)
    lastReported = now
  }

  cb(null, chunk)
}

async function run() {
  const inputStream = await getDocumentsStream(client, client.config().dataset)
  console.log('Got HTTP %d', inputStream.statusCode)
  console.log('Response headers: %o', inputStream.headers)

  const jsonStream = miss.pipeline(
    inputStream,
    split(tryParseJson),
    rejectOnApiError(),
    filterSystemDocuments(),
    filterDocumentTypes(undefined),
    filterDrafts(),
    stringifyStream(),
    miss.through(reportDocumentCount)
  )

  miss.pipe(jsonStream, process.stdout, async err => {
    if (err) {
      console.error(err)
      process.exit(1)
    }

    console.log()
  })
}

run()
